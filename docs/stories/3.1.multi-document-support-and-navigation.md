# Story 3.1: Multi-Document Support and Navigation

## Status

Draft

## Story

**As a** user,
**I want** to create and manage multiple markdown documents,
**so that** I can organize my notes into separate files.

## Acceptance Criteria

1. Users can create new documents with custom names
2. Document list/navigator shows all saved documents
3. Users can switch between documents without losing unsaved changes
4. Documents can be renamed and deleted through the interface
5. Current document is clearly indicated in the navigation

## Tasks / Subtasks

- [ ] Implement document storage service layer (AC: 1, 3)
  - [ ] Create DocumentService class in src/services/documents/
  - [ ] Implement create, read, update, delete operations for documents
  - [ ] Add document validation and sanitization
  - [ ] Implement auto-save functionality with unsaved changes tracking
- [ ] Create storage abstraction layer (AC: 1, 3)
  - [ ] Install and configure Dexie.js for IndexedDB management
  - [ ] Create StorageService class in src/services/storage/
  - [ ] Define Document data model and TypeScript interfaces in src/types/
  - [ ] Implement database initialization and versioning
- [ ] Build document navigation UI components (AC: 2, 5)
  - [ ] Create DocumentNavigator component in src/components/navigation/
  - [ ] Create DocumentList component to display all documents
  - [ ] Add current document indicator and visual feedback
  - [ ] Implement responsive navigation sidebar layout
- [ ] Implement document creation and management interface (AC: 1, 4)
  - [ ] Add "Create New Document" button and modal
  - [ ] Create DocumentCreator component with name input
  - [ ] Implement document rename functionality with inline editing
  - [ ] Add document deletion with confirmation dialog
- [ ] Integrate document switching with editor state (AC: 3)
  - [ ] Update AppLayout to include document navigation
  - [ ] Create useDocuments hook for document state management
  - [ ] Implement document switching without losing editor changes
  - [ ] Add loading states for document operations
- [ ] Add comprehensive testing for document management (AC: 1-5)
  - [ ] Unit tests for DocumentService and StorageService
  - [ ] Integration tests for document CRUD operations
  - [ ] Component tests for navigation and document management UI
  - [ ] E2E tests for complete document workflow scenarios

## Dev Notes

### Previous Story Context

[Source: Story 2.2 Implementation]

Key insights from Story 2.2 completion:

- **IndexedDB Foundation**: Story 1.3 defines the storage layer architecture using Dexie.js and IndexedDB with encryption
- **React State Management**: React Context + useReducer pattern established for complex state management
- **Performance Optimization**: Debounced auto-save (300ms delay) pattern for non-blocking operations
- **Component Architecture**: Modular React components with TypeScript for maintainability
- **Keyboard Shortcuts**: KeyboardShortcutService provides foundation for document navigation shortcuts

### Architecture and Tech Stack

[Source: architecture/high-level-architecture.md#technical-summary]

- **Local Storage**: IndexedDB via Dexie.js for document persistence with large storage capacity
- **Frontend Framework**: React 18.2+ with TypeScript 5.0+ for component architecture
- **State Management**: React Context + useReducer for document and editor state
- **Encryption**: Web Crypto API for data security (local-first approach)
- **Performance**: Debounced operations, in-memory caching, background storage

### Document Management Specifications

[Source: architecture/high-level-architecture.md#architectural-patterns]

**Document-Centric Design**: All functionality centers around document entities and operations - core architectural pattern for user mental model alignment.

**Event-Driven State Management**: React Context and reducers for predictable state updates managing complex editor state, document switching, and operations reliably.

**Local-First Data Architecture**: All persistence and operations happen locally with no external dependencies for maximum privacy and offline functionality.

### Data Models and Storage Architecture

[Source: docs/stories/1.3.basic-local-storage-implementation.md#data-models-and-schema]

Core Document interface to implement:

```typescript
interface Document {
  id: string;
  title: string;
  content: any; // ProseMirror JSON document
  markdownSource: string;
  createdAt: Date;
  updatedAt: Date;
  folderId: string | null;
  tags: string[];
  isDeleted: boolean;
  wordCount: number;
  version: number;
}
```

IndexedDB Object Store schema:

```sql
Documents {
  id: string (primary key),
  title: string (indexed),
  content: any, // ProseMirror JSON
  markdownSource: string,
  createdAt: Date (indexed),
  updatedAt: Date (indexed),
  folderId: string (indexed),
  tags: string[] (multiEntry indexed),
  isDeleted: boolean (indexed),
  wordCount: number,
  version: number
}
```

### Project Structure Alignment

[Source: Current project structure analysis]

Key files to create/enhance:

```
wysiwyg-md-editor/
├── src/services/
│   ├── storage/
│   │   ├── StorageService.ts              # NEW: IndexedDB abstraction layer
│   │   └── EncryptionService.ts           # NEW: Web Crypto API wrapper
│   └── documents/
│       └── DocumentService.ts             # NEW: Document business logic
├── src/components/navigation/
│   ├── DocumentNavigator.tsx              # NEW: Navigation sidebar container
│   ├── DocumentList.tsx                   # NEW: Document list display
│   ├── DocumentCreator.tsx                # NEW: New document creation modal
│   └── DocumentItem.tsx                   # NEW: Individual document list item
├── src/components/layout/
│   └── AppLayout.tsx                      # ENHANCE: Add navigation integration
├── src/hooks/
│   ├── useDocuments.ts                    # NEW: Document management hook
│   ├── useStorage.ts                      # NEW: General storage hook
│   └── useAutoSave.ts                     # NEW: Auto-save functionality hook
├── src/types/
│   ├── document.ts                        # NEW: Document type definitions
│   └── storage.ts                         # NEW: Storage type definitions
├── src/pages/
│   └── NewTab.tsx                         # ENHANCE: Document switching integration
└── src/utils/
    ├── storage.ts                         # NEW: Storage utility functions
    └── validation.ts                      # NEW: Document validation utilities
```

### Storage Service Architecture

[Source: docs/stories/1.3.basic-local-storage-implementation.md#storage-architecture-patterns]

- **Repository Pattern**: Abstraction layer over IndexedDB operations
- **Service Layer**: Business logic for document management
- **Encryption Middleware**: Transparent encryption/decryption layer
- **Error Handling**: Comprehensive error handling with user feedback

### Performance Requirements

[Source: docs/stories/1.3.basic-local-storage-implementation.md#performance-requirements]

- **Response Time Target**: <100ms for all local storage operations
- **Caching Strategy**: In-memory caching for frequently accessed documents
- **Auto-save Debouncing**: 300ms delay to prevent excessive writes
- **Background Operations**: Non-blocking storage operations

### Integration Requirements

**Editor Integration**:

- Must integrate with existing SimpleProseMirrorEditor without disrupting functionality
- Document switching should preserve editor state and keyboard shortcuts
- Auto-save should work seamlessly with existing editor onChange events

**Layout Integration**:

- Navigation sidebar should integrate with existing AppLayout component
- Responsive design must maintain editor focus and usability
- Current document indicator should be prominent and intuitive

**State Management Integration**:

- Leverage existing React Context patterns from keyboard shortcut implementation
- Document state should be separate from editor state for clean separation of concerns
- Loading states and error handling should follow established patterns

### Security Requirements

[Source: docs/stories/1.3.basic-local-storage-implementation.md#security-requirements]

- **Data Encryption**: All document content encrypted using Web Crypto API
- **Local Only**: No external network requests for core functionality
- **Input Validation**: Comprehensive validation for all user inputs
- **Secure Storage**: Browser-provided encryption APIs only

### Testing

#### Test file location:

Tests should be created in `tests/services/` and `tests/components/navigation/` directories

#### Test standards:

[Source: docs/stories/2.2 testing patterns]

- **Component Testing**: React Testing Library for navigation components and document management UI
- **Integration Testing**: Document service and storage service integration with complete CRUD workflows
- **E2E Testing**: Complete document management workflows (create, switch, rename, delete)
- **Performance Testing**: Storage operation timing and memory usage

#### Testing requirements for this story:

- Unit tests for DocumentService (CRUD operations, validation, auto-save)
- Unit tests for StorageService (IndexedDB operations, encryption integration)
- Component tests for DocumentNavigator, DocumentList, DocumentCreator with user interactions
- Integration tests for document switching without losing editor changes
- E2E tests for complete document management workflows
- Performance tests for storage operations and document switching times
- Error handling tests for storage failures and invalid inputs

#### Specific Test Patterns:

[Source: docs/stories/2.2 test examples]

Use Vitest + React Testing Library pattern:

```typescript
import { render, screen, fireEvent } from "@testing-library/react";
import { vi } from "vitest";
import { DocumentNavigator } from "@/components/navigation/DocumentNavigator";

// Test pattern for document management testing
it("should create and switch between documents", async () => {
  // Test document creation with custom names
  // Test document list display and navigation
  // Test current document indication
  // Test document switching without data loss
});
```

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2025-09-13 | v1.0    | Initial story creation | Bob (SM) |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

*(To be filled by dev agent)*

### Debug Log References

*(To be filled by dev agent)*

### Completion Notes List

*(To be filled by dev agent)*

### File List

*(To be filled by dev agent)*

## QA Results

*(Results from QA Agent QA review will be populated here after implementation)*